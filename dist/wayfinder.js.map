{"version":3,"file":"wayfinder.js","sources":["../wayfinder-crate/pkg/wayfinder.js","../src/index.ts"],"sourcesContent":["let wasm;\n\nconst cachedTextDecoder = (typeof TextDecoder !== 'undefined' ? new TextDecoder('utf-8', { ignoreBOM: true, fatal: true }) : { decode: () => { throw Error('TextDecoder not available') } } );\n\nif (typeof TextDecoder !== 'undefined') { cachedTextDecoder.decode(); };\n\nlet cachedUint8ArrayMemory0 = null;\n\nfunction getUint8ArrayMemory0() {\n    if (cachedUint8ArrayMemory0 === null || cachedUint8ArrayMemory0.byteLength === 0) {\n        cachedUint8ArrayMemory0 = new Uint8Array(wasm.memory.buffer);\n    }\n    return cachedUint8ArrayMemory0;\n}\n\nfunction getStringFromWasm0(ptr, len) {\n    ptr = ptr >>> 0;\n    return cachedTextDecoder.decode(getUint8ArrayMemory0().subarray(ptr, ptr + len));\n}\n\nfunction isLikeNone(x) {\n    return x === undefined || x === null;\n}\n\nlet cachedDataViewMemory0 = null;\n\nfunction getDataViewMemory0() {\n    if (cachedDataViewMemory0 === null || cachedDataViewMemory0.buffer.detached === true || (cachedDataViewMemory0.buffer.detached === undefined && cachedDataViewMemory0.buffer !== wasm.memory.buffer)) {\n        cachedDataViewMemory0 = new DataView(wasm.memory.buffer);\n    }\n    return cachedDataViewMemory0;\n}\n\nfunction debugString(val) {\n    // primitive types\n    const type = typeof val;\n    if (type == 'number' || type == 'boolean' || val == null) {\n        return  `${val}`;\n    }\n    if (type == 'string') {\n        return `\"${val}\"`;\n    }\n    if (type == 'symbol') {\n        const description = val.description;\n        if (description == null) {\n            return 'Symbol';\n        } else {\n            return `Symbol(${description})`;\n        }\n    }\n    if (type == 'function') {\n        const name = val.name;\n        if (typeof name == 'string' && name.length > 0) {\n            return `Function(${name})`;\n        } else {\n            return 'Function';\n        }\n    }\n    // objects\n    if (Array.isArray(val)) {\n        const length = val.length;\n        let debug = '[';\n        if (length > 0) {\n            debug += debugString(val[0]);\n        }\n        for(let i = 1; i < length; i++) {\n            debug += ', ' + debugString(val[i]);\n        }\n        debug += ']';\n        return debug;\n    }\n    // Test for built-in\n    const builtInMatches = /\\[object ([^\\]]+)\\]/.exec(toString.call(val));\n    let className;\n    if (builtInMatches.length > 1) {\n        className = builtInMatches[1];\n    } else {\n        // Failed to match the standard '[object ClassName]'\n        return toString.call(val);\n    }\n    if (className == 'Object') {\n        // we're a user defined class or Object\n        // JSON.stringify avoids problems with cycles, and is generally much\n        // easier than looping through ownProperties of `val`.\n        try {\n            return 'Object(' + JSON.stringify(val) + ')';\n        } catch (_) {\n            return 'Object';\n        }\n    }\n    // errors\n    if (val instanceof Error) {\n        return `${val.name}: ${val.message}\\n${val.stack}`;\n    }\n    // TODO we could test for more things here, like `Set`s and `Map`s.\n    return className;\n}\n\nlet WASM_VECTOR_LEN = 0;\n\nconst cachedTextEncoder = (typeof TextEncoder !== 'undefined' ? new TextEncoder('utf-8') : { encode: () => { throw Error('TextEncoder not available') } } );\n\nconst encodeString = (typeof cachedTextEncoder.encodeInto === 'function'\n    ? function (arg, view) {\n    return cachedTextEncoder.encodeInto(arg, view);\n}\n    : function (arg, view) {\n    const buf = cachedTextEncoder.encode(arg);\n    view.set(buf);\n    return {\n        read: arg.length,\n        written: buf.length\n    };\n});\n\nfunction passStringToWasm0(arg, malloc, realloc) {\n\n    if (realloc === undefined) {\n        const buf = cachedTextEncoder.encode(arg);\n        const ptr = malloc(buf.length, 1) >>> 0;\n        getUint8ArrayMemory0().subarray(ptr, ptr + buf.length).set(buf);\n        WASM_VECTOR_LEN = buf.length;\n        return ptr;\n    }\n\n    let len = arg.length;\n    let ptr = malloc(len, 1) >>> 0;\n\n    const mem = getUint8ArrayMemory0();\n\n    let offset = 0;\n\n    for (; offset < len; offset++) {\n        const code = arg.charCodeAt(offset);\n        if (code > 0x7F) break;\n        mem[ptr + offset] = code;\n    }\n\n    if (offset !== len) {\n        if (offset !== 0) {\n            arg = arg.slice(offset);\n        }\n        ptr = realloc(ptr, len, len = offset + arg.length * 3, 1) >>> 0;\n        const view = getUint8ArrayMemory0().subarray(ptr + offset, ptr + len);\n        const ret = encodeString(arg, view);\n\n        offset += ret.written;\n        ptr = realloc(ptr, len, offset, 1) >>> 0;\n    }\n\n    WASM_VECTOR_LEN = offset;\n    return ptr;\n}\n\nfunction passArray8ToWasm0(arg, malloc) {\n    const ptr = malloc(arg.length * 1, 1) >>> 0;\n    getUint8ArrayMemory0().set(arg, ptr / 1);\n    WASM_VECTOR_LEN = arg.length;\n    return ptr;\n}\n\nfunction addToExternrefTable0(obj) {\n    const idx = wasm.__externref_table_alloc();\n    wasm.__wbindgen_export_2.set(idx, obj);\n    return idx;\n}\n\nfunction passArrayJsValueToWasm0(array, malloc) {\n    const ptr = malloc(array.length * 4, 4) >>> 0;\n    const mem = getDataViewMemory0();\n    for (let i = 0; i < array.length; i++) {\n        mem.setUint32(ptr + 4 * i, addToExternrefTable0(array[i]), true);\n    }\n    WASM_VECTOR_LEN = array.length;\n    return ptr;\n}\n\nfunction getArrayJsValueFromWasm0(ptr, len) {\n    ptr = ptr >>> 0;\n    const mem = getDataViewMemory0();\n    const result = [];\n    for (let i = ptr; i < ptr + 4 * len; i += 4) {\n        result.push(wasm.__wbindgen_export_2.get(mem.getUint32(i, true)));\n    }\n    wasm.__externref_drop_slice(ptr, len);\n    return result;\n}\n\nexport function start() {\n    wasm.start();\n}\n\nfunction handleError(f, args) {\n    try {\n        return f.apply(this, args);\n    } catch (e) {\n        const idx = addToExternrefTable0(e);\n        wasm.__wbindgen_exn_store(idx);\n    }\n}\n\nconst WayfinderFinalization = (typeof FinalizationRegistry === 'undefined')\n    ? { register: () => {}, unregister: () => {} }\n    : new FinalizationRegistry(ptr => wasm.__wbg_wayfinder_free(ptr >>> 0, 1));\n\nexport class Wayfinder {\n\n    __destroy_into_raw() {\n        const ptr = this.__wbg_ptr;\n        this.__wbg_ptr = 0;\n        WayfinderFinalization.unregister(this);\n        return ptr;\n    }\n\n    free() {\n        const ptr = this.__destroy_into_raw();\n        wasm.__wbg_wayfinder_free(ptr, 0);\n    }\n    constructor() {\n        const ret = wasm.wayfinder_new();\n        this.__wbg_ptr = ret >>> 0;\n        WayfinderFinalization.register(this, this.__wbg_ptr, this);\n        return this;\n    }\n    /**\n     * @param {Rectangle | undefined} bounds\n     */\n    addBounds(bounds) {\n        wasm.wayfinder_addBounds(this.__wbg_ptr, bounds);\n    }\n    /**\n     * @param {Uint8Array} pixels\n     * @param {Rectangle | undefined} bounds\n     * @param {Rectangle | undefined} scaled_bounds\n     */\n    addExplored(pixels, bounds, scaled_bounds) {\n        const ptr0 = passArray8ToWasm0(pixels, wasm.__wbindgen_malloc);\n        const len0 = WASM_VECTOR_LEN;\n        wasm.wayfinder_addExplored(this.__wbg_ptr, ptr0, len0, bounds, scaled_bounds);\n    }\n    /**\n     * @param {SquareGrid | HexagonalGrid | GridlessGrid} grid\n     */\n    addGrid(grid) {\n        wasm.wayfinder_addGrid(this.__wbg_ptr, grid);\n    }\n    /**\n     * @param {Token} token\n     */\n    addToken(token) {\n        wasm.wayfinder_addToken(this.__wbg_ptr, token);\n    }\n    /**\n     * @param {(WallDocument)[]} wall_documents\n     */\n    addWalls(wall_documents) {\n        const ptr0 = passArrayJsValueToWasm0(wall_documents, wasm.__wbindgen_malloc);\n        const len0 = WASM_VECTOR_LEN;\n        wasm.wayfinder_addWalls(this.__wbg_ptr, ptr0, len0);\n    }\n    /**\n     * @param {(Point)[]} path\n     * @param {Point} goal\n     * @returns {(Point)[]}\n     */\n    findPath(path, goal) {\n        const ptr0 = passArrayJsValueToWasm0(path, wasm.__wbindgen_malloc);\n        const len0 = WASM_VECTOR_LEN;\n        const ret = wasm.wayfinder_findPath(this.__wbg_ptr, ptr0, len0, goal);\n        var v2 = getArrayJsValueFromWasm0(ret[0], ret[1]).slice();\n        wasm.__wbindgen_free(ret[0], ret[1] * 4, 4);\n        return v2;\n    }\n}\n\nasync function __wbg_load(module, imports) {\n    if (typeof Response === 'function' && module instanceof Response) {\n        if (typeof WebAssembly.instantiateStreaming === 'function') {\n            try {\n                return await WebAssembly.instantiateStreaming(module, imports);\n\n            } catch (e) {\n                if (module.headers.get('Content-Type') != 'application/wasm') {\n                    console.warn(\"`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\\n\", e);\n\n                } else {\n                    throw e;\n                }\n            }\n        }\n\n        const bytes = await module.arrayBuffer();\n        return await WebAssembly.instantiate(bytes, imports);\n\n    } else {\n        const instance = await WebAssembly.instantiate(module, imports);\n\n        if (instance instanceof WebAssembly.Instance) {\n            return { instance, module };\n\n        } else {\n            return instance;\n        }\n    }\n}\n\nfunction __wbg_get_imports() {\n    const imports = {};\n    imports.wbg = {};\n    imports.wbg.__wbindgen_is_object = function(arg0) {\n        const val = arg0;\n        const ret = typeof(val) === 'object' && val !== null;\n        return ret;\n    };\n    imports.wbg.__wbindgen_string_new = function(arg0, arg1) {\n        const ret = getStringFromWasm0(arg0, arg1);\n        return ret;\n    };\n    imports.wbg.__wbindgen_number_get = function(arg0, arg1) {\n        const obj = arg1;\n        const ret = typeof(obj) === 'number' ? obj : undefined;\n        getDataViewMemory0().setFloat64(arg0 + 8 * 1, isLikeNone(ret) ? 0 : ret, true);\n        getDataViewMemory0().setInt32(arg0 + 4 * 0, !isLikeNone(ret), true);\n    };\n    imports.wbg.__wbindgen_array_new = function() {\n        const ret = [];\n        return ret;\n    };\n    imports.wbg.__wbindgen_array_push = function(arg0, arg1) {\n        arg0.push(arg1);\n    };\n    imports.wbg.__wbindgen_number_new = function(arg0) {\n        const ret = arg0;\n        return ret;\n    };\n    imports.wbg.__wbindgen_boolean_get = function(arg0) {\n        const v = arg0;\n        const ret = typeof(v) === 'boolean' ? (v ? 1 : 0) : 2;\n        return ret;\n    };\n    imports.wbg.__wbg_new_abda76e883ba8a5f = function() {\n        const ret = new Error();\n        return ret;\n    };\n    imports.wbg.__wbg_stack_658279fe44541cf6 = function(arg0, arg1) {\n        const ret = arg1.stack;\n        const ptr1 = passStringToWasm0(ret, wasm.__wbindgen_malloc, wasm.__wbindgen_realloc);\n        const len1 = WASM_VECTOR_LEN;\n        getDataViewMemory0().setInt32(arg0 + 4 * 1, len1, true);\n        getDataViewMemory0().setInt32(arg0 + 4 * 0, ptr1, true);\n    };\n    imports.wbg.__wbg_error_f851667af71bcfc6 = function(arg0, arg1) {\n        let deferred0_0;\n        let deferred0_1;\n        try {\n            deferred0_0 = arg0;\n            deferred0_1 = arg1;\n            console.error(getStringFromWasm0(arg0, arg1));\n        } finally {\n            wasm.__wbindgen_free(deferred0_0, deferred0_1, 1);\n        }\n    };\n    imports.wbg.__wbindgen_is_function = function(arg0) {\n        const ret = typeof(arg0) === 'function';\n        return ret;\n    };\n    imports.wbg.__wbg_next_13b477da1eaa3897 = function(arg0) {\n        const ret = arg0.next;\n        return ret;\n    };\n    imports.wbg.__wbg_next_b06e115d1b01e10b = function() { return handleError(function (arg0) {\n        const ret = arg0.next();\n        return ret;\n    }, arguments) };\n    imports.wbg.__wbg_done_983b5ffcaec8c583 = function(arg0) {\n        const ret = arg0.done;\n        return ret;\n    };\n    imports.wbg.__wbg_value_2ab8a198c834c26a = function(arg0) {\n        const ret = arg0.value;\n        return ret;\n    };\n    imports.wbg.__wbg_iterator_695d699a44d6234c = function() {\n        const ret = Symbol.iterator;\n        return ret;\n    };\n    imports.wbg.__wbg_get_ef828680c64da212 = function() { return handleError(function (arg0, arg1) {\n        const ret = Reflect.get(arg0, arg1);\n        return ret;\n    }, arguments) };\n    imports.wbg.__wbg_call_a9ef466721e824f2 = function() { return handleError(function (arg0, arg1) {\n        const ret = arg0.call(arg1);\n        return ret;\n    }, arguments) };\n    imports.wbg.__wbg_new_e69b5f66fda8f13c = function() {\n        const ret = new Object();\n        return ret;\n    };\n    imports.wbg.__wbg_set_e864d25d9b399c9f = function() { return handleError(function (arg0, arg1, arg2) {\n        const ret = Reflect.set(arg0, arg1, arg2);\n        return ret;\n    }, arguments) };\n    imports.wbg.__wbindgen_debug_string = function(arg0, arg1) {\n        const ret = debugString(arg1);\n        const ptr1 = passStringToWasm0(ret, wasm.__wbindgen_malloc, wasm.__wbindgen_realloc);\n        const len1 = WASM_VECTOR_LEN;\n        getDataViewMemory0().setInt32(arg0 + 4 * 1, len1, true);\n        getDataViewMemory0().setInt32(arg0 + 4 * 0, ptr1, true);\n    };\n    imports.wbg.__wbindgen_throw = function(arg0, arg1) {\n        throw new Error(getStringFromWasm0(arg0, arg1));\n    };\n    imports.wbg.__wbindgen_init_externref_table = function() {\n        const table = wasm.__wbindgen_export_2;\n        const offset = table.grow(4);\n        table.set(0, undefined);\n        table.set(offset + 0, undefined);\n        table.set(offset + 1, null);\n        table.set(offset + 2, true);\n        table.set(offset + 3, false);\n        ;\n    };\n\n    return imports;\n}\n\nfunction __wbg_init_memory(imports, memory) {\n\n}\n\nfunction __wbg_finalize_init(instance, module) {\n    wasm = instance.exports;\n    __wbg_init.__wbindgen_wasm_module = module;\n    cachedDataViewMemory0 = null;\n    cachedUint8ArrayMemory0 = null;\n\n\n    wasm.__wbindgen_start();\n    return wasm;\n}\n\nfunction initSync(module) {\n    if (wasm !== undefined) return wasm;\n\n\n    if (typeof module !== 'undefined') {\n        if (Object.getPrototypeOf(module) === Object.prototype) {\n            ({module} = module)\n        } else {\n            console.warn('using deprecated parameters for `initSync()`; pass a single object instead')\n        }\n    }\n\n    const imports = __wbg_get_imports();\n\n    __wbg_init_memory(imports);\n\n    if (!(module instanceof WebAssembly.Module)) {\n        module = new WebAssembly.Module(module);\n    }\n\n    const instance = new WebAssembly.Instance(module, imports);\n\n    return __wbg_finalize_init(instance, module);\n}\n\nasync function __wbg_init(module_or_path) {\n    if (wasm !== undefined) return wasm;\n\n\n    if (typeof module_or_path !== 'undefined') {\n        if (Object.getPrototypeOf(module_or_path) === Object.prototype) {\n            ({module_or_path} = module_or_path)\n        } else {\n            console.warn('using deprecated parameters for the initialization function; pass a single object instead')\n        }\n    }\n\n    if (typeof module_or_path === 'undefined') {\n        module_or_path = new URL('wayfinder_bg.wasm', import.meta.url);\n    }\n    const imports = __wbg_get_imports();\n\n    if (typeof module_or_path === 'string' || (typeof Request === 'function' && module_or_path instanceof Request) || (typeof URL === 'function' && module_or_path instanceof URL)) {\n        module_or_path = fetch(module_or_path);\n    }\n\n    __wbg_init_memory(imports);\n\n    const { instance, module } = await __wbg_load(await module_or_path, imports);\n\n    return __wbg_finalize_init(instance, module);\n}\n\nexport { initSync };\nexport default __wbg_init;\n","import init, { Wayfinder } from \"wayfinder-crate\";\r\n\r\ndeclare global {\r\n    interface ClientSettings {\r\n        get(module: \"wayfinder\", setting: \"enablePathfinding\"): boolean;\r\n        get(module: \"wayfinder\", setting: \"fogExploration\"): boolean;\r\n        //get(module: \"wayfinder\", setting: \"enableMovementHistory\"): boolean;\r\n\r\n        set(module: \"wayfinder\", setting: \"enablePathfinding\", value: boolean): Promise<boolean>;\r\n        set(module: \"wayfinder\", setting: \"fogExploration\", value: boolean): Promise<boolean>;\r\n        //set(module: \"wayfinder\", setting: \"enableMovementHistory\", value: boolean): Promise<boolean>;\r\n    }\r\n\r\n    interface TokenDocument {\r\n        //getFlag(scope: \"wayfinder\", key: \"movementHistory\"): WayfinderMovementHistory | undefined;\r\n    }\r\n\r\n    interface Ruler {\r\n        wayfinder?: Wayfinder;\r\n    }\r\n}\r\n\r\n//interface WayfinderMovementHistory {}\r\n\r\ntype WayfinderPoint = Point & {\r\n    path: Point[];\r\n};\r\n\r\nfunction isWayfinderPoint(point: Point | null): point is WayfinderPoint {\r\n    if (point === null) return false;\r\n    return (point as WayfinderPoint).path !== undefined;\r\n}\r\n\r\nfunction getPath(history: RulerMeasurementHistoryWaypoint[], waypoints: Point[], destination?: Point | null) {\r\n    const path = (history as Point[]).concat(waypoints);\r\n\r\n    if (destination) {\r\n        if (isWayfinderPoint(destination)) {\r\n            path.push(...destination.path);\r\n        } else {\r\n            path.push(destination);\r\n        }\r\n    }\r\n\r\n    return path;\r\n}\r\n\r\nHooks.once(\"init\", async () => {\r\n    game.settings.register(\"wayfinder\", \"enablePathfinding\", {\r\n        name: \"enablePathfinding\",\r\n        scope: \"client\",\r\n        config: false,\r\n        type: Boolean,\r\n        default: false,\r\n    });\r\n\r\n    game.settings.register(\"wayfinder\", \"fogExploration\", {\r\n        name: \"wayfinder.settings.fogExploration.name\",\r\n        hint: \"wayfinder.settings.fogExploration.hint\",\r\n        scope: \"world\",\r\n        config: true,\r\n        type: Boolean,\r\n        default: true,\r\n    });\r\n\r\n    /*game.settings.register(\"wayfinder\", \"enableMovementHistory\", {\r\n        name: \"wayfinder.settings.enableMovementHistory.name\",\r\n        hint: \"wayfinder.settings.enableMovementHistory.hint\",\r\n        scope: \"world\",\r\n        config: true,\r\n        requiresReload: true,\r\n        type: Boolean,\r\n        default: true,\r\n    });*/\r\n\r\n    await init();\r\n});\r\n\r\nHooks.once(\"ready\", () => {\r\n    if (CONFIG.Canvas.rulerClass.name !== \"RulerPF2e\") {\r\n        ui.notifications.error(\"Wayfinder has been disabled because RulerPF2e is not the default ruler!\");\r\n        return;\r\n    }\r\n\r\n    libWrapper.register<Ruler, Ruler[\"_startMeasurement\"]>(\r\n        \"wayfinder\",\r\n        \"CONFIG.Canvas.rulerClass.prototype._startMeasurement\",\r\n        function (this: Ruler, wrapped: Ruler[\"_startMeasurement\"], ...args: Parameters<Ruler[\"_startMeasurement\"]>) {\r\n            if (this.state !== Ruler.STATES.INACTIVE) return;\r\n\r\n            if (game.settings.get(\"wayfinder\", \"enablePathfinding\") && args[1]?.token) {\r\n                this.wayfinder = new Wayfinder();\r\n\r\n                this.wayfinder.addGrid(canvas.grid);\r\n                this.wayfinder.addToken(args[1].token);\r\n                this.wayfinder.addBounds(canvas.scene?.dimensions.sceneRect);\r\n                this.wayfinder.addWalls(canvas.walls.placeables.map((w) => w.document));\r\n\r\n                if (canvas.scene?.fog.exploration && game.settings.get(\"wayfinder\", \"fogExploration\")) {\r\n                    if (!game.settings.get(\"pf2e\", \"gmVision\") && args[1].token.document.sight.enabled) {\r\n                        let scale = 0.1;\r\n                        let sceneRect = canvas.dimensions.sceneRect;\r\n                        let scaledRect = new PIXI.Rectangle(\r\n                            sceneRect.x * scale,\r\n                            sceneRect.y * scale,\r\n                            sceneRect.width * scale,\r\n                            sceneRect.height * scale\r\n                        );\r\n\r\n                        let renderTexture = PIXI.RenderTexture.create({ width: scaledRect.width, height: scaledRect.height });\r\n                        let transform = new PIXI.Matrix(scale, 0, 0, scale, -scaledRect.x, -scaledRect.y);\r\n                        canvas.app.renderer.render(canvas.visibility.explored, { renderTexture, transform });\r\n\r\n                        let explored_pixels = canvas.app.renderer.extract.pixels(renderTexture) as Uint8Array;\r\n\r\n                        this.wayfinder.addExplored(\r\n                            explored_pixels,\r\n                            canvas.dimensions.sceneRect,\r\n                            new PIXI.Rectangle(0, 0, renderTexture.width, renderTexture.height)\r\n                        );\r\n                    }\r\n                }\r\n            }\r\n\r\n            wrapped(...args);\r\n        }\r\n    );\r\n\r\n    libWrapper.register<Ruler, Ruler[\"_endMeasurement\"]>(\r\n        \"wayfinder\",\r\n        \"CONFIG.Canvas.rulerClass.prototype._endMeasurement\",\r\n        function (this: Ruler, wrapped: Ruler[\"_endMeasurement\"]) {\r\n            if (this.state !== Ruler.STATES.MEASURING) return;\r\n\r\n            wrapped();\r\n            this.wayfinder?.free();\r\n            this.wayfinder = undefined;\r\n        }\r\n    );\r\n\r\n    libWrapper.register<Ruler, Ruler[\"_getMeasurementDestination\"]>(\r\n        \"wayfinder\",\r\n        \"CONFIG.Canvas.rulerClass.prototype._getMeasurementDestination\",\r\n        function (this: Ruler, wrapped: Ruler[\"_getMeasurementDestination\"], ...args: Parameters<Ruler[\"_getMeasurementDestination\"]>) {\r\n            let destination = wrapped(...args);\r\n\r\n            if (this.user == game.user && args[1]?.snap) {\r\n                if (this.token && this.wayfinder && game.settings.get(\"wayfinder\", \"enablePathfinding\")) {\r\n                    let path = this.wayfinder.findPath(getPath(this.history, this.waypoints), destination);\r\n                    let mode =\r\n                        Math.max(this.token.document.width, 1) % 2 === 1\r\n                            ? CONST.GRID_SNAPPING_MODES.CENTER\r\n                            : CONST.GRID_SNAPPING_MODES.BOTTOM_RIGHT_VERTEX;\r\n\r\n                    if (path && path.length > 1) {\r\n                        return {\r\n                            x: destination.x,\r\n                            y: destination.y,\r\n                            path: path.map((point) => canvas.grid.getSnappedPoint(point, { mode })),\r\n                        };\r\n                    }\r\n                }\r\n            }\r\n\r\n            return destination;\r\n        }\r\n    );\r\n\r\n    libWrapper.register<Ruler, Ruler[\"_getMeasurementSegments\"]>(\r\n        \"wayfinder\",\r\n        \"CONFIG.Canvas.rulerClass.prototype._getMeasurementSegments\",\r\n        function (this: Ruler, _wrapped: Ruler[\"_getMeasurementSegments\"]) {\r\n            const segments: RulerMeasurementSegment[] = [];\r\n            const path = getPath(this.history, this.waypoints, this.destination);\r\n\r\n            for (let i = 1; i < path.length; i++) {\r\n                const label =\r\n                    (this.labels.children.at(i - 1) as PreciseText) ?? this.labels.addChild(new PreciseText(\"\", CONFIG.canvasTextStyle));\r\n                const ray = new Ray(path[i - 1], path[i]);\r\n                segments.push({\r\n                    ray,\r\n                    teleport: i < this.history.length ? this.history[i].teleport : i === this.history.length && ray.distance > 0,\r\n                    label,\r\n                    distance: 0,\r\n                    cost: 0,\r\n                    cumulativeDistance: 0,\r\n                    cumulativeCost: 0,\r\n                    history: i <= this.history.length,\r\n                    first: i === this.history.length + 1,\r\n                    last: i === path.length - 1,\r\n                    // @ts-expect-error\r\n                    animation: {},\r\n                });\r\n            }\r\n\r\n            if (this.labels.children.length > segments.length) {\r\n                this.labels.removeChildren(segments.length).forEach((c) => c.destroy());\r\n            }\r\n\r\n            return segments;\r\n        }\r\n    );\r\n\r\n    libWrapper.register<Ruler, Ruler[\"_addWaypoint\"]>(\r\n        \"wayfinder\",\r\n        \"CONFIG.Canvas.rulerClass.prototype._addWaypoint\",\r\n        function (this: Ruler, _wrapped: Ruler[\"_addWaypoint\"], ...args: Parameters<Ruler[\"_addWaypoint\"]>) {\r\n            if (this.state !== Ruler.STATES.STARTING && this.state !== Ruler.STATES.MEASURING) return;\r\n            const waypoint =\r\n                this.state === Ruler.STATES.STARTING\r\n                    ? this._getMeasurementOrigin(args[0], { snap: args[1]?.snap })\r\n                    : this._getMeasurementDestination(args[0], { snap: args[1]?.snap });\r\n\r\n            if (isWayfinderPoint(waypoint)) {\r\n                this.waypoints.push(...waypoint.path);\r\n            } else {\r\n                this.waypoints.push(waypoint);\r\n            }\r\n\r\n            this._state = Ruler.STATES.MEASURING;\r\n            const destination = this.destination ?? args[0];\r\n            this.measure({ x: destination.x, y: destination.y }, { snap: args[1]?.snap, force: true });\r\n        }\r\n    );\r\n});\r\n\r\nHooks.on(\"getSceneControlButtons\", (controls: SceneControl[]) => {\r\n    if (!canvas.scene) return;\r\n\r\n    const tokenControls = controls.find((c) => c.name === \"token\");\r\n    const rulerIndex = tokenControls?.tools.findIndex((t) => t.name === \"ruler\");\r\n\r\n    if (rulerIndex) {\r\n        tokenControls?.tools.splice(rulerIndex + 1, 0, {\r\n            visible: true,\r\n            name: \"pathfinding\",\r\n            title: \"wayfinder.controls.pathfinding\",\r\n            icon: \"fa-duotone fa-solid fa-compass\",\r\n            toggle: true,\r\n            active: game.settings.get(\"wayfinder\", \"enablePathfinding\"),\r\n            onClick: () => {\r\n                const newStatus = !game.settings.get(\"wayfinder\", \"enablePathfinding\");\r\n                game.settings.set(\"wayfinder\", \"enablePathfinding\", newStatus);\r\n            },\r\n        });\r\n    }\r\n});\r\n"],"names":["wasm","cachedTextDecoder","cachedUint8ArrayMemory0","getUint8ArrayMemory0","getStringFromWasm0","ptr","len","isLikeNone","x","cachedDataViewMemory0","getDataViewMemory0","debugString","val","type","description","name","length","debug","builtInMatches","className","WASM_VECTOR_LEN","cachedTextEncoder","encodeString","arg","view","buf","passStringToWasm0","malloc","realloc","mem","offset","code","ret","passArray8ToWasm0","addToExternrefTable0","obj","idx","passArrayJsValueToWasm0","array","i","getArrayJsValueFromWasm0","result","handleError","f","args","e","WayfinderFinalization","Wayfinder","bounds","pixels","scaled_bounds","ptr0","len0","grid","token","wall_documents","path","goal","v2","__wbg_load","module","imports","bytes","instance","__wbg_get_imports","arg0","arg1","v","ptr1","len1","deferred0_0","deferred0_1","arg2","table","__wbg_finalize_init","__wbg_init","module_or_path","isWayfinderPoint","point","getPath","history","waypoints","destination","init","wrapped","_a","_b","_c","w","scale","sceneRect","scaledRect","renderTexture","transform","explored_pixels","mode","_wrapped","segments","label","ray","c","waypoint","controls","tokenControls","rulerIndex","t","newStatus"],"mappings":"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"}